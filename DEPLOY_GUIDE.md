# CantoSub AI - å®Œæ•´éƒ¨ç½²æŒ‡å—

## ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          å‰ç«¯ (Vercel)                           â”‚
â”‚                     React + Tailwind CSS                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ HTTPS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        åç«¯ (Railway)                            â”‚
â”‚              Node.js + Express + Supabase                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Auth API   â”‚  â”‚  OCR API    â”‚  â”‚  Payment API (Stripe)   â”‚ â”‚
â”‚  â”‚  (JWT)      â”‚  â”‚  (Kimi)     â”‚  â”‚                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Usage API  â”‚  â”‚  File API   â”‚  â”‚  Admin API              â”‚ â”‚
â”‚  â”‚  (è¿½è¸ª)     â”‚  â”‚  (R2/S3)    â”‚  â”‚  (ç®¡ç†åå°)              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Supabase â”‚          â”‚Cloudflareâ”‚          â”‚    Stripe    â”‚
â”‚(DB+Auth) â”‚          â”‚    R2    â”‚          â”‚  (æ”¯ä»˜å¤„ç†)   â”‚
â”‚ å…è´¹é¢åº¦  â”‚          â”‚  10GBå…è´¹ â”‚          â”‚  æ— æœˆè´¹       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡è´¦å·

### 1.1 Supabase (æ•°æ®åº“)

1. è®¿é—® [supabase.com](https://supabase.com)
2. æ³¨å†Œè´¦å·
3. åˆ›å»ºæ–°é¡¹ç›®
4. è·å– **Project URL** å’Œ **Service Role Key**
   - Settings â†’ API â†’ Project URL
   - Settings â†’ API â†’ service_role key (æ³¨æ„ä¸æ˜¯ anon key)

### 1.2 Cloudflare R2 (æ–‡ä»¶å­˜å‚¨)

1. è®¿é—® [cloudflare.com](https://cloudflare.com)
2. æ³¨å†Œè´¦å·
3. è¿›å…¥ R2 æœåŠ¡
4. åˆ›å»º Bucket
5. è·å– API Token
   - Manage R2 API Tokens â†’ Create API Token
   - æƒé™ï¼šObject Read & Write

### 1.3 Stripe (æ”¯ä»˜)

1. è®¿é—® [stripe.com](https://stripe.com)
2. æ³¨å†Œè´¦å·
3. è·å– API Keys
   - Developers â†’ API Keys â†’ Secret key
4. è®¾ç½® Webhook
   - Developers â†’ Webhooks â†’ Add endpoint
   - URL: `https://your-backend.railway.app/api/payments/webhook`
   - é€‰æ‹©äº‹ä»¶ï¼š`checkout.session.completed`, `invoice.payment_succeeded`, `customer.subscription.deleted`

### 1.4 Kimi (OCR)

1. è®¿é—® [platform.moonshot.cn](https://platform.moonshot.cn)
2. æ³¨å†Œè´¦å·
3. åˆ›å»º API Key

### 1.5 Railway (éƒ¨ç½²)

1. è®¿é—® [railway.app](https://railway.app)
2. ç”¨ GitHub è´¦å·ç™»å½•

---

## ç¬¬äºŒæ­¥ï¼šé…ç½®åç«¯

### 2.1 å…‹éš†ä»£ç 

```bash
git clone https://github.com/your-username/cantosub-backend.git
cd cantosub-backend
```

### 2.2 å®‰è£…ä¾èµ–

```bash
npm install
```

### 2.3 é…ç½®ç¯å¢ƒå˜é‡

```bash
cp .env.example .env
```

ç¼–è¾‘ `.env`ï¼š

```env
NODE_ENV=production
PORT=3000
FRONTEND_URL=https://your-frontend.vercel.app

SUPABASE_URL=https://xxxxx.supabase.co
SUPABASE_SERVICE_KEY=eyJ...

JWT_SECRET=your-super-secret-key-at-least-32-characters

KIMI_API_KEY=sk-...

STRIPE_SECRET_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...

R2_ENDPOINT=https://xxxxx.r2.cloudflarestorage.com
R2_ACCESS_KEY_ID=...
R2_SECRET_ACCESS_KEY=...
R2_BUCKET_NAME=cantosub-files

ADMIN_API_KEY=your-admin-dashboard-key
```

### 2.4 æ•°æ®åº“è¿ç§»

```bash
npm run db:migrate
```

---

## ç¬¬ä¸‰æ­¥ï¼šéƒ¨ç½²åˆ° Railway

### 3.1 åˆ›å»ºé¡¹ç›®

```bash
# å®‰è£… Railway CLI
npm install -g @railway/cli

# ç™»å½•
railway login

# åˆå§‹åŒ–é¡¹ç›®
railway init
```

### 3.2 æ·»åŠ ç¯å¢ƒå˜é‡

```bash
railway variables

# æˆ–è€…é€šè¿‡ Dashboard æ·»åŠ 
```

æ·»åŠ æ‰€æœ‰ç¯å¢ƒå˜é‡ï¼ˆè§ 2.3ï¼‰

### 3.3 éƒ¨ç½²

```bash
railway up
```

### 3.4 è·å–åŸŸå

```bash
railway domain
```

å¤åˆ¶ç”Ÿæˆçš„åŸŸåï¼Œä¾‹å¦‚ï¼š`https://cantosub-api.up.railway.app`

---

## ç¬¬å››æ­¥ï¼šéƒ¨ç½²å‰ç«¯

### 4.1 æ›´æ–°å‰ç«¯ API åœ°å€

ç¼–è¾‘å‰ç«¯ä»£ç ä¸­çš„ API é…ç½®ï¼š

```javascript
// src/config/api.js
const API_BASE_URL = 'https://your-backend.railway.app/api';
```

### 4.2 éƒ¨ç½²åˆ° Vercel

```bash
# å®‰è£… Vercel CLI
npm install -g vercel

# éƒ¨ç½²
vercel --prod
```

---

## ç¬¬äº”æ­¥ï¼šé…ç½® Stripe Webhook

1. è¿›å…¥ Stripe Dashboard
2. Developers â†’ Webhooks
3. Add endpoint
4. Endpoint URL: `https://your-backend.railway.app/api/payments/webhook`
5. é€‰æ‹©äº‹ä»¶ï¼š
   - `checkout.session.completed`
   - `invoice.payment_succeeded`
   - `customer.subscription.deleted`
6. å¤åˆ¶ Signing secret åˆ°ç¯å¢ƒå˜é‡ `STRIPE_WEBHOOK_SECRET`

---

## ç¬¬å…­æ­¥ï¼šæµ‹è¯•

### 6.1 å¥åº·æ£€æŸ¥

```bash
curl https://your-backend.railway.app/health
```

### 6.2 æ³¨å†Œç”¨æˆ·

```bash
curl -X POST https://your-backend.railway.app/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"password123","name":"Test User"}'
```

### 6.3 ç™»å½•

```bash
curl -X POST https://your-backend.railway.app/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"password123"}'
```

---

## è´¹ç”¨ä¼°ç®—ï¼ˆæ¯æœˆï¼‰

| æœåŠ¡ | å…è´¹é¢åº¦ | é¢„ä¼°è´¹ç”¨ |
|------|---------|---------|
| **Railway** | $5 | $5-20 |
| **Supabase** | 500MB DB + 1GB å­˜å‚¨ | $0 |
| **Cloudflare R2** | 10GB å­˜å‚¨ | $0 |
| **Stripe** | æ— æœˆè´¹ | æŒ‰äº¤æ˜“ 2.9%+30Â¢ |
| **Kimi API** | æ–°ç”¨æˆ·èµ é€ | $10-50 |
| **Vercel** | 100GB å¸¦å®½ | $0 |

**æ€»è®¡ï¼šçº¦ $15-70/æœˆ**ï¼ˆå–å†³äºç”¨æˆ·é‡ï¼‰

---

## ç®¡ç†åå°

è®¿é—®ç®¡ç†åå°ï¼š

```bash
curl https://your-backend.railway.app/api/admin/stats \
  -H "X-Admin-Api-Key: your-admin-api-key"
```

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥

æ£€æŸ¥ `SUPABASE_SERVICE_KEY` æ˜¯å¦æ­£ç¡®ï¼ˆä¸æ˜¯ anon keyï¼‰

### é—®é¢˜ï¼šæ–‡ä»¶ä¸Šä¼ å¤±è´¥

æ£€æŸ¥ R2 é…ç½®å’Œ Bucket æƒé™

### é—®é¢˜ï¼šæ”¯ä»˜å¤±è´¥

æ£€æŸ¥ Stripe API Key å’Œ Webhook é…ç½®

### é—®é¢˜ï¼šOCR å¤±è´¥

æ£€æŸ¥ Kimi API Key æ˜¯å¦æœ‰æ•ˆ

---

## ä¸‹ä¸€æ­¥

1. âœ… éƒ¨ç½²åç«¯åˆ° Railway
2. âœ… éƒ¨ç½²å‰ç«¯åˆ° Vercel
3. âœ… é…ç½® Stripe Webhook
4. âœ… æµ‹è¯•å®Œæ•´æµç¨‹
5. ğŸ”„ æ·»åŠ æ›´å¤šåŠŸèƒ½ï¼ˆé‚®ä»¶é€šçŸ¥ã€åˆ†æç­‰ï¼‰
